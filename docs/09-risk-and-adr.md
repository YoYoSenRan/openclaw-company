# 09. 风险台账与 ADR（Architecture Decision Records）

## Scope
记录当前已识别风险、应对策略与关键架构决策，确保后续迭代可追溯。

## Non-goals
- 不作为详细故障复盘报告。

## Out-of-scope
- 不覆盖组织层面风险（人员流动、预算审批）。

## 风险台账（当前）

### R-001：OpenClaw 协议变更风险
- 描述：Gateway 协议可能随版本演进导致字段变化。
- 影响：BFF 映射层可能失效。
- 概率：中
- 严重度：高
- 缓解：
  1. 协议映射集中在单模块。
  2. 引入契约测试。
  3. 保留 `state.resync` 回退机制。

### R-002：实时事件风暴导致前端卡顿
- 描述：高频事件导致渲染压力过高。
- 影响：FPS 下降、交互延迟。
- 概率：中
- 严重度：高
- 缓解：
  1. 事件批处理与节流。
  2. 动画降级策略。
  3. UI 订阅最小化。

### R-003：技术栈版本耦合
- 描述：某些插件对 Fastify 主版本支持受限。
- 影响：升级困难、兼容问题。
- 概率：中
- 严重度：中
- 缓解：
  1. 默认使用 Fastify 官方 `@fastify/websocket`。
  2. 不把核心链路绑定在社区桥接插件上。

### R-004：Spine 许可与资产流程成本
- 描述：关键角色若用 Spine，存在许可与导出流程要求。
- 影响：成本和交付周期增加。
- 概率：中
- 严重度：中
- 缓解：
  1. MVP 先用 Aseprite 帧动画。
  2. 仅核心角色引入 Spine。

### R-005：命令重复提交引发副作用
- 描述：网络抖动重发可能造成重复执行。
- 影响：任务错乱、状态不一致。
- 概率：高
- 严重度：高
- 缓解：
  1. `requestId` 幂等去重。
  2. 状态机迁移守卫。
  3. 审计日志追踪。

### R-006：前端核心依赖“三新叠加”风险
- 描述：React 19.x + Vite 7 + PixiJS 8 同时采用，生态兼容风险叠加。
- 影响：构建兼容、插件稳定性、排障成本增加。
- 概率：中
- 严重度：高
- 缓解：
  1. Phase 0 强制执行技术验证 Spike。
  2. 明确降级路径（Vite 6 / React 18 兼容方案预案）。
  3. 将渲染层与业务层解耦，降低替换成本。

### R-007：`@pixi/react` 桥接层稳定性风险
- 描述：React 与 Pixi 的桥接库若出现兼容问题，影响整个渲染层。
- 影响：画面渲染异常、热更新失效。
- 概率：中
- 严重度：高
- 缓解：
  1. 先做最小场景压测与 HMR 验证。
  2. 保留“纯 Pixi 容器渲染”后备方案。
  3. 关键场景避免过深 React 组件嵌套。

### R-008：EasyStar 维护活跃度风险
- 描述：寻路库维护节奏偏慢，遇到边界问题可能需要自维护。
- 影响：路径异常修复成本上升。
- 概率：中
- 严重度：中
- 缓解：
  1. Phase 0 对比 `EasyStar` 与 `pathfinding` 两套方案。
  2. 以同一寻路接口封装，便于后续切换实现。
  3. 复杂障碍场景建立回归用例。

### R-009：事件溯源与同步复杂度低估
- 描述：乱序、丢包、重连会导致状态冲突与一致性问题。
- 影响：UI 与服务端状态偏差，回放失真。
- 概率：中
- 严重度：高
- 缓解：
  1. 明确 `seq + agentSeq + snapshot` 三段式恢复。
  2. 客户端实现冲突对账日志。
  3. 在测试矩阵中加入乱序/丢包专项。

## ADR 记录

## ADR-001：采用“经营 + 指挥”双模式
- 状态：Accepted
- 日期：2026-02-14
- 背景：单纯看板缺乏可玩性，纯游戏缺乏实用性。
- 决策：双模式共存，共用状态机与事件流。
- 影响：产品更复杂，但价值密度更高。

## ADR-002：实时主链路采用 WebSocket JSON 包络
- 状态：Accepted
- 日期：2026-02-14
- 背景：OpenClaw Gateway 原生 WS；需要低延迟双向通信。
- 决策：Browser-BFF 与 BFF-Gateway 都以 WS 为主。
- 影响：协议统一，调试路径清晰。

## ADR-003：BFF 使用 Fastify + @fastify/websocket
- 状态：Accepted
- 日期：2026-02-14
- 背景：需稳定 WS 路由能力，并减少插件耦合。
- 决策：采用 Fastify 官方 WS 插件，不将核心依赖绑定在 Fastify4 限定插件。
- 影响：需自行实现部分广播与会话管理逻辑。

## ADR-004：前端渲染采用 PixiJS + @pixi/react
- 状态：Accepted
- 日期：2026-02-14
- 背景：需要高性能 2D 渲染且前端团队熟悉 React。
- 决策：用 React 管理 UI，用 Pixi 承载场景渲染。
- 影响：需要明确 UI 状态与场景状态边界。

## ADR-005：状态管理采用 Zustand + XState
- 状态：Accepted
- 日期：2026-02-14
- 背景：同时需要轻量全局状态与严格状态迁移控制。
- 决策：Zustand 管全局，XState 管 Agent 生命周期。
- 影响：需要统一事件驱动范式，避免双写。

### ADR-005 实施约束（避免双写）
1. 单一写入原则：实体状态仅允许由“事件归约层”写入。
2. UI 直接操作只能发命令，不得直接改实体状态。
3. Zustand 仅存视图状态（筛选、面板开关、镜头参数）。
4. XState 仅处理 Agent 生命周期，不直接持久化业务实体。

## ADR-006：角色动画分层策略
- 状态：Accepted
- 日期：2026-02-14
- 背景：希望“卡通拟人不简陋”，又要控制制作成本。
- 决策：普通角色帧动画，关键角色可选 Spine。
- 影响：资产流程需维护两套导出规范。

## 待决策项（Open）
1. 是否在 Phase 2 引入 Redis（还是 Phase 4 再引入）。
2. 是否在 v0.x 期接入多人协同操控。
3. 是否为回放引擎引入压缩存储策略。

### 待决策项跟进节奏
- 跟进频率：每个里程碑评审必审一次。
- 最晚决策时间点：
  1. Redis 启用时机：不晚于 Phase 1 结束。
  2. 多人协同：不晚于 Phase 2 结束。
  3. 回放压缩策略：不晚于 Phase 3 结束。

## 技术可行性核验摘要（2026-02-14）
1. OpenClaw 官方文档明确 Gateway 为 WS 控制平面，并定义 connect/req/res/event 结构。
2. OpenClaw 提供 `/tools/invoke` HTTP 入口可补充指令调用。
3. React 19.2、Vite 7、PixiJS 8、@pixi/react 8 具备可落地条件。
4. Fastify 官方 WebSocket 插件可用于稳定 WS 服务。

## 风险复审节奏
- 每周一次风险审查。
- 每个里程碑结束后更新 ADR 和风险状态。
