# 07. 开发流程与交付治理

## Scope
定义从需求进入到上线交付的标准流程、门禁、测试策略与回归机制。

## Non-goals
- 不定义组织管理流程（绩效、排期会议制度）。

## Out-of-scope
- 不包含完整 CI/CD 平台配置细节。

## 流程总览
1. 需求进入与范围确认。
2. 文档对齐（先文档后代码）。
3. 任务拆分与优先级排序。
4. 开发实现（小步迭代）。
5. 测试验证（单元/集成/手工关键路径）。
6. 评审与验收。
7. 发布与回归观察。

## Phase 1：需求与文档对齐

### 输入
- 新功能需求或问题单。

### 动作
1. 标注影响文档（00~09 哪些章节需要改）。
2. 完成文档修订并评审通过。
3. 给出验收标准与边界（做什么/不做什么）。

### 输出
- 可执行任务列表。

## Phase 2：任务拆分

### 规则
1. 单任务建议 0.5~1.5 天。
2. 一个任务只对应一个核心目标。
3. 每个任务必须标注文档引用。

### 任务模板
- `Title`
- `Goal`
- `Ref Docs`
- `Scope`
- `Non-goals`
- `Test Plan`
- `Done Criteria`

## Phase 3：开发实现

### 原则
1. 最小可行增量（Vertical Slice）。
2. 优先实现可观测和可回滚能力。
3. 不做无需求支持的扩展功能。

### 分支与评审规则
1. 采用 `main + feature/*` 的短生命周期分支策略。
2. 所有功能改动通过 PR 合并，至少 1 名 reviewer 批准。
3. 涉及协议/状态机变更的 PR，必须附文档引用与回归截图/日志。

### 代码提交建议
- 提交信息格式：
  - `feat: ...`
  - `fix: ...`
  - `refactor: ...`
  - `docs: ...`
  - `test: ...`

## Phase 4：测试策略

## 测试目录
- 根目录固定：`/tests`

## 测试类型
1. 单元测试
- 状态机迁移
- 协议校验
- 命令幂等

2. 集成测试
- BFF 与 Gateway Mock
- 断线重连
- 事件回放

3. 关键路径手工测试
- 电话派单
- 面交派单
- 阻塞处理
- 回放查看

## 测试执行要求
1. 每次迭代至少覆盖一个新增核心路径自动化测试。
2. 测试结束后检查临时文件（`.tmp`, `.log`, `test.db` 等）。
3. 临时文件必须删除或加入 `.gitignore`。

## 测试报告模板
- 版本/分支
- 测试范围
- 通过/失败统计
- 失败用例与原因
- 风险评估

## Phase 5：评审与验收

### 评审清单
1. 是否严格符合文档定义。
2. 是否引入未授权范围扩展。
3. 是否具备回退与降级策略。
4. 是否补充必要测试与日志。

### 验收清单
1. 功能路径可复现。
2. 关键指标达到基线。
3. 风险项有记录和处理建议。

## Phase 6：发布与观测

### 发布前
1. 锁定版本号与变更摘要。
2. 执行发布前 smoke test。
3. 确认 `docs` 与实现版本一致。

### 发布后
1. 观察 30~60 分钟关键指标。
2. 重点查看：连接稳定性、命令失败率、渲染性能。
3. 如异常超阈值，执行回滚或降级。

### 回滚步骤（最小流程）
1. 立即切换流量到上一稳定版本（或停用新功能开关）。
2. 触发 `state.resync`，确保客户端状态回归稳定。
3. 记录回滚原因、影响范围、恢复时间。
4. 24 小时内补充复盘与防复发项。

## 缺陷处理流程
1. P0/P1：立即进入修复通道。
2. 先复现再修复，避免猜测改动。
3. 修复后必须补充回归用例。

## 变更控制
1. 若开发中发现架构路径不可行：
   - 先暂停。
   - 更新文档与计划，标记阻塞原因。
   - 评审通过后继续。
2. 严禁“先改代码后补文档”。

## 环境管理
1. 至少维护 `dev/staging/prod` 三套环境配置。
2. staging 必须接近 prod（协议版本、配置结构一致）。
3. 任何高风险变更先经过 staging 验证再进 prod。

## 版本发布策略
1. 采用语义化版本（`major.minor.patch`）。
2. `minor` 用于功能增量，`patch` 用于兼容修复。
3. 发布说明必须包含“变更点 + 风险点 + 回滚点”。

## 技术债务管理
1. 技术债务必须登记到任务系统并标注偿还优先级。
2. 每个里程碑至少处理 1 个高影响技术债务项。
3. 不允许“口头技术债”长期悬空。

## 完成定义（DoD）
- 文档一致。
- 代码通过检查。
- 测试通过。
- 无临时垃圾文件。
- 发布说明可追溯。
